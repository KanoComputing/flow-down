<script>
    (FlowDown => {
        let storesCount = 0;
        FlowDown.createStore = (initialState) => {
            let watchers = [],
                mutators = [],
                storeId = storesCount++,
                appStateComponent,
                providerMixin, receiverMixin;
            function addWatcher (component, property, propertyName, setValue) {
                watchers.push({
                    set: setValue,
                    component: component,
                    property: property,
                    propertyName: propertyName
                });
            }
            function removeWatchers () {
                watchers = [];
            }
            function addMutator (mutator) {
                mutators.push(mutator);
            }
            receiverMixin = (parent) => {
                return class StateReceiverMixin extends parent {
                    connectedCallback () {
                        super.connectedCallback();
                        if (!this.constructor.properties) {
                            return;
                        }
                        Object.keys(this.constructor.properties).forEach((propertyName) => {
                            var property = this.constructor.properties[propertyName];
                            if (property.linkState){
                                this.set(propertyName, appStateComponent.get(property.linkState));
                                var setValue = (path, value) => {
                                    this.set(path, value);
                                    this.notifyPath(path);
                                };
                                addWatcher(this, property, propertyName, setValue);
                            }
                        });
                    }
                    disconnectedCallback () {
                        super.disconnectedCallback();
                        removeWatchers();
                    }
                    getState () {
                        return appStateComponent.state;
                    }
                    dispatch (action) {
                        window.dispatchEvent(new CustomEvent(`action-${storeId}`, { detail: action }));
                    }
                }
            };
            providerMixin = (parent) => {
                return class StateProviderBehavior extends parent {
                    constructor () {
                        super();
                        appStateComponent = this;
                        window.addEventListener(`action-${storeId}`, this._onAction.bind(this));
                    }
                    addMutator (mutator) {
                        addMutator(mutator);
                    }
                    _onAction (e) {
                        let action = e.detail;
                        mutators.forEach(mutator => {
                            mutator.call({
                                get: this.get,
                                set: this.set,
                                push: this.push,
                                pop: this.pop,
                                splice: this.splice,
                                shift: this.shift,
                                unshift: this.unshift
                            }, action);
                        });
                    }
                    static get properties() {
                        return {
                            state: {
                                type: Object,
                                value: () => {
                                    return initialState || {};
                                }
                            }
                        };
                    }
                    static get observers() {
                        return ['_stateChanged(state.*)'];
                    }
                    getState () {
                        return this.state;
                    }
                    _stateChanged (changeRecord) {
                        watchers.forEach((watcher) => {
                            let statePath = `state.${watcher.property.linkState}`;
                            if (changeRecord.path == statePath) {
                                // Perfect match of paths
                                watcher.set(watcher.propertyName, changeRecord.value);
                            } else if (changeRecord.path.startsWith(statePath)) {
                                if (changeRecord.path.endsWith('.splices')) {
                                    // Splice changes
                                    var value = this.get(statePath);
                                    watcher.set(watcher.propertyName, value.slice());
                                } else {
                                    if (watcher.property.type === Array && changeRecord.path.endsWith('.length')) {
                                        // Avoid changing the lengths of arrays
                                        return;
                                    }
                                    // Parent change
                                    watcher.set(changeRecord.path.replace(statePath, watcher.propertyName), changeRecord.value);
                                }
                            } else if (statePath.startsWith(changeRecord.path)) {
                                // Parent node in the path was changed, update the value altogether
                                watcher.set(watcher.propertyName, this.get(statePath));
                            }
                        });
                    }
                }
            };
            return {
                StateReceiver: receiverMixin,
                StateProvider: providerMixin,
                addMutator
            }
        };
    })(window.FlowDown = window.FlowDown || {});

</script>